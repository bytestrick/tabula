<div class="table-responsive space-left-right">
  <table class="table app-table-bordered" (mouseleave)="onMouseLeaveTable()">
    <colgroup #colgroup>
      <col class="first-column">
      <col
        *ngFor="let _ of this.table.getHeadersCells(); let columnIndex = index"
        [attr.data-index]="columnIndex"
        class="column"
      >
    </colgroup>
    <thead>
      <!-- riga per i table-organizer -->
      <tr
        cdkDropList
        cdkDropListOrientation="horizontal"
        (cdkDropListDropped)="onColumnDropped($event)"
      >
        <!-- serve per aggiungere la cella della colonna iniziale, quella per il table-organizer delle righe -->
        <th (mouseenter)="onMouseEnteredCell(-1, -1)"></th>

        <th
          *ngFor="let _ of this.table.getHeadersCells(); let colIndex = index"
          class="center-td-content-v-h"
          (mouseenter)="onMouseEnteredCell(-1, colIndex)"
        >
          <app-table-organizer
            cdkDrag
            (cdkDragStarted)="onDragStarted()"
            (cdkDragEnded)="onDragEnded()"

            [showOrganizer]="hoveredColIndex === colIndex && !isAnElementDragged"
            [rowIndicators]="false"
            (addAt)="onColumnAddedAt(colIndex)"
            (selectionToggle)="onColumnSelectionToggled($event, colIndex)"
          >
            <!-- Preview della colonna durante il drag and drop -->
            <div *cdkDragPreview class="drag-preview column-preview">
              <i class="bi bi-arrow-left-right"></i>
              <div
                *ngFor="let cell of table.getCol(colIndex, previewLimit)"
                class="preview-cell"
              >
                {{ cell.value }}
              </div>
            </div>
          </app-table-organizer>
        </th>

        <!-- serve per aggiungere la cella della colonna finale, quella dove c'è il bottone per aggiungere le colonne -->
        <th (mouseenter)="onMouseEnteredCell(-1, -1)"></th>
      </tr>

      <!-- riga per i data-type -->
      <tr>
        <!-- serve per aggiungere la cella della colonna iniziale, quella per il table-organizer delle righe -->
        <th (mouseenter)="onMouseEnteredCell(-1, -1)"></th>
        <th
          *ngFor="let headerCell of this.table.getHeadersCells(); let colIndex = index"
          class="center-td-content-v-h"
          (mouseenter)="onMouseEnteredCell(-1, colIndex)"
          style="padding: 0; position: relative;"
          appResizableTableColumn [colIndex]="colIndex" [colgroup]="colgroup"
        >
          <app-cell-wrapper
            #cellWrapper
            appHighlightBorders [appHighlightBordersOf]="cellWrapper.bordersToHighLight.nativeElement" [appHighlightCanDisable]="!isInputMethodVisible"
            [headerCell]="headerCell"
            (dblclick)="onDoubleClickedCell($event, -1, colIndex)"
          ></app-cell-wrapper>
          <div class="resize-handle"></div>
        </th>
        <!-- serve per aggiungere la cella della colonna finale, quella dove c'è il bottone per aggiungere le colonne -->
        <th class="remove-border center-container" (mouseenter)="onMouseEnteredCell(-1, -1)">
          <button class="btn btn-primary center" type="button" (click)="onNewColumnAdded()" title="Append new column">
            <i class="bi bi-plus-lg"></i>
          </button>
        </th>
      </tr>
    </thead>
    <tbody
      cdkDropList
      (cdkDropListDropped)="onRowDropped($event)"
    >
      <!-- righe per gli elementi della tabella -->
      <tr
        *ngFor="let row of table.getRows(); let rowIndex = index"
      >
        <!-- celle per contenere i table-organizer delle righe -->
        <td class="remove-border center-td-content-v-h" (mouseenter)="onMouseEnteredCell(rowIndex, -1)">
          <app-table-organizer
            [showOrganizer]="hoveredRowIndex === rowIndex && !isAnElementDragged"
            [rowIndicators]="true"
            (addAt)="onRowAddedAt(rowIndex)"
            (selectionToggle)="onRowSelectionToggled($event, rowIndex)"

            cdkDrag
            (cdkDragStarted)="onDragStarted()"
            (cdkDragEnded)="onDragEnded()"
          >
            <!-- Preview della riga durante il drag and drop -->
            <div *cdkDragPreview class="drag-preview row-preview">
              <i class="bi bi-arrow-down-up"></i>
              <div
                *ngFor="let cell of table.getRow(rowIndex, previewLimit)"
                class="preview-cell"
              >
                {{ cell.value }}
              </div>
            </div>
          </app-table-organizer>
        </td>

        <!-- celle in cui inserire i dati -->
        <td
          #areaToSelect
          *ngFor="let cell of row; let colIndex = index"
          (mouseenter)="onMouseEnteredCell(rowIndex, colIndex)"
          style="padding: 0"
        >
          <app-cell-wrapper
            #cellWrapper
            appHighlightBorders [appHighlightBordersOf]="cellWrapper.bordersToHighLight.nativeElement" [appHighlightCanDisable]="!isInputMethodVisible"
            appSelect [appIsSelected]="isRowSelected(rowIndex) || isColumnSelected(colIndex)" [appTargetOfSelection]="areaToSelect"
            [selectedNeighbors]="{
              top: isRowSelected(rowIndex - 1) || (rowIndex - 1 >= 0 && isColumnSelected(colIndex)),
              bottom: isRowSelected(rowIndex + 1) || (rowIndex + 1 < table.getRowsNumber() && isColumnSelected(colIndex)),
              left: isColumnSelected(colIndex - 1) || (colIndex - 1 >= 0 && isRowSelected(rowIndex)),
              right: isColumnSelected(colIndex + 1) || (colIndex + 1 < table.getHeadersCellsAmount() && isRowSelected(rowIndex))
            }"
            [cell]="cell"
            (dblclick)="onDoubleClickedCell($event, rowIndex, colIndex)"
          ></app-cell-wrapper>
        </td>

        <!--
          serve per aggiungere la cella della colonna finale, quella dove c'è il bottone per aggiungere le colonne
        -->
        <td (mouseenter)="onMouseEnteredCell(-1, -1)"></td>
      </tr>
    </tbody>
    <tbody>
      <tr> <!-- riga dove sta il bottone di aggiunta righe -->
        <!-- serve per aggiungere la la cella della colonna iniziale, quella per il table-organizer delle righe -->
        <td (mouseenter)="onMouseEnteredCell(-1, -1)"></td>

        <td style="border-right-color: transparent; border-left-color: transparent;" class="center-td-content-v" (mouseenter)="onMouseEnteredCell(-1, -1)">
          <button class="btn btn-primary" type="button" (click)="onNewRowAdded()" title="Append new row">
            <i class="bi bi-plus-lg"></i>
          </button>
        </td>

        <!--
          aggiunge le restanti celle. Non sfora perché ci sono due colonne in più. Una per il bottone di aggiunta
          colonne e una per i table-organizer delle righe
        -->
        <td style="border-right-color: transparent; border-left-color: transparent;" *ngFor="let cell of table.getHeadersCells()" (mouseenter)="onMouseEnteredCell(-1, -1)"></td>
      </tr>
    </tbody>
  </table>
</div>

<app-pop-up
  *ngIf="isInputMethodVisible" (close)="onInputPopUpClosed($event)"
  [position]="inputMethodPosition"
  [inputComponent]="inputComponent"
  [inputComponentInitialValue]="inputComponentInitialValue">
</app-pop-up>
